# OTOADA - Airtable to Supabase Migration Analysis

## 1. Codebase Analysis Summary

### Current Airtable Integration Points

The application interacts with Airtable in the following files:

1. **`config.js`**
   - Contains: `AIRTABLE_API_KEY` and `AIRTABLE_BASE_ID`
   - Usage: Configuration for all API calls

2. **`airtable.js`** (Main listing page)
   - Function: `fetchCarsFromAirtable()` - Fetches all cars, filters by `Durum = 'Yayında'`
   - Operations: READ (GET requests)
   - Table: "Table 1"
   - Sorting: By `createdTime` DESC (newest first)
   - Client-side filtering: Brand, Model, Location, Fuel, Gear, Price range, Search

3. **`detail.js`** (Car detail page)
   - Function: `fetchCarDetail()` - Fetches single car by ID
   - Function: `renderSimilarCars()` - Fetches cars with same brand
   - Operations: READ (GET requests)
   - Table: "Table 1"

4. **`upload.js`** (Upload form)
   - Function: Form submission handler
   - Operations: CREATE (POST requests)
   - Table: "Table 1"
   - Creates records with `Durum = 'Onay Bekliyor'`

5. **`admin.js`** (Admin dashboard)
   - Function: `fetchAllCars()` - Fetches all records (no filter)
   - Function: `updateCarStatus()` - Updates `Durum` field
   - Function: `deleteCar()` - Deletes record
   - Function: `saveCarEdit()` - Updates car fields (PATCH)
   - Operations: CREATE, READ, UPDATE, DELETE
   - Table: "Table 1"
   - Filtering: By `Durum` (Onay Bekliyor, Yayında, Satıldı, Reddedildi)

### Airtable Data Structure

**Table Name:** "Table 1"

**Fields Identified:**

| Airtable Field | Type | Required | Notes |
|---------------|------|----------|-------|
| `id` | Record ID | Yes | Auto-generated by Airtable |
| `createdTime` | Timestamp | Yes | Auto-generated by Airtable |
| `Marka` | Text | Yes | Brand (e.g., "Mercedes", "BMW") |
| `Model` | Text | Yes | Model (e.g., "e250d", "320d") |
| `Fiyat` | Number | Yes | Price |
| `ParaBirimi` | Select | Yes | Options: "STG", "TL", "EUR" (default: "STG") |
| `Durum` | Select | Yes | Options: "Onay Bekliyor", "Yayında", "Satıldı", "Reddedildi" (default: "Onay Bekliyor") |
| `Resim` | Attachment | Yes | Array of image objects: `[{url: "...", thumbnails: {...}}]` |
| `Yil` | Number | No | Year |
| `KM` | Number | No | Kilometers |
| `Yakit` | Text/Select | No | Fuel type (e.g., "Dizel", "Benzin") |
| `Vites` | Text/Select | No | Transmission (e.g., "Manuel", "Otomatik") |
| `Kasa Tipi` | Text | No | Body type |
| `Renk` | Text | No | Color |
| `Aciklama` | Long Text | No | Description |
| `Satici` | Text | No | Seller name |
| `Telefon` | Text | No | Phone number |
| `Konum` | Text | No | Location |
| `Ekspertiz` / `Hasar Durumu` | Text | No | Damage report |

## 2. PostgreSQL Schema Mapping

### Design Decisions

1. **Primary Key:** UUID instead of Airtable record ID (more scalable, standard for Supabase)
2. **Images:** Normalized into separate `car_images` table (better for queries, indexing)
3. **Enums:** Used PostgreSQL ENUM types for `Durum` and `ParaBirimi` (data integrity, performance)
4. **Timestamps:** Added `updated_at` field (not in Airtable, useful for tracking changes)
5. **Naming:** Used snake_case for PostgreSQL (standard convention)
6. **Indexes:** Added comprehensive indexes for common queries (performance optimization)

### Schema Structure

```
cars (main table)
├── id (UUID, PK)
├── marka (VARCHAR)
├── model (VARCHAR)
├── fiyat (NUMERIC)
├── para_birimi (ENUM: STG, TL, EUR)
├── durum (ENUM: Onay Bekliyor, Yayında, Satıldı, Reddedildi)
├── yil (INTEGER)
├── km (INTEGER)
├── yakit (VARCHAR)
├── vites (VARCHAR)
├── kasa_tipi (VARCHAR)
├── renk (VARCHAR)
├── aciklama (TEXT)
├── satici (VARCHAR)
├── telefon (VARCHAR)
├── konum (VARCHAR)
├── ekspertiz (TEXT)
├── created_at (TIMESTAMPTZ)
└── updated_at (TIMESTAMPTZ)

car_images (normalized images)
├── id (UUID, PK)
├── car_id (UUID, FK → cars.id)
├── image_url (TEXT)
├── thumbnail_url (TEXT)
├── display_order (INTEGER)
└── created_at (TIMESTAMPTZ)
```

## 3. Migration Plan - Next Steps

### Phase 1: Setup Supabase Project
1. Create Supabase project at https://supabase.com
2. Run `supabase_schema.sql` in Supabase SQL Editor
3. Note down Supabase credentials:
   - Project URL (e.g., `https://xxxxx.supabase.co`)
   - Anon/public key (for client-side access)
   - Service role key (for admin operations, server-side only)

### Phase 2: Data Migration Script
1. Create a migration script (`migrate_airtable_to_supabase.js` or similar)
2. Script should:
   - Fetch all records from Airtable (using existing API key)
   - Transform data structure:
     - Convert Airtable record ID to UUID (or generate new UUID)
     - Extract images from attachment field into `car_images` table
     - Map field names (Airtable → PostgreSQL)
     - Convert `createdTime` to `created_at`
   - Insert data into Supabase using Supabase JavaScript client
   - Handle batch inserts (Supabase supports batch operations)
   - Log migration progress and errors

### Phase 3: Update JavaScript Files

#### 3.1 Install Supabase Client
```bash
npm install @supabase/supabase-js
# OR include via CDN in HTML files
```

#### 3.2 Update `config.js`
Replace Airtable config with Supabase config:
```javascript
// Supabase Configuration
const SUPABASE_URL = 'https://xxxxx.supabase.co';
const SUPABASE_ANON_KEY = 'your-anon-key';
const SUPABASE_SERVICE_KEY = 'your-service-key'; // For admin only
```

#### 3.3 Create `supabase.js` (Helper Module)
Create a new file with Supabase client initialization and helper functions:
```javascript
import { createClient } from '@supabase/supabase-js';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
// Export supabase client and helper functions
```

#### 3.4 Update `airtable.js` → `cars.js`
- Replace `fetchCarsFromAirtable()` with Supabase query
- Use `.from('cars').select('*, car_images(*)')` for joins
- Implement filtering using Supabase `.eq()`, `.gte()`, `.lte()` methods
- Update sorting: `.order('created_at', { ascending: false })`
- Update filtering logic to use Supabase PostgREST filters

#### 3.5 Update `detail.js`
- Replace `fetchCarDetail()` with Supabase `.from('cars').select().eq('id', id).single()`
- Update `renderSimilarCars()` with Supabase query

#### 3.6 Update `upload.js`
- Replace Airtable POST with Supabase `.from('cars').insert()`
- Insert images separately into `car_images` table
- Use transactions or batch operations for atomicity

#### 3.7 Update `admin.js`
- Replace all CRUD operations:
  - READ: `.from('cars').select('*, car_images(*)')`
  - CREATE: `.from('cars').insert()`
  - UPDATE: `.from('cars').update().eq('id', id)`
  - DELETE: `.from('cars').delete().eq('id', id)`
- Use service role key for admin operations (or configure RLS policies)

### Phase 4: Row Level Security (RLS) Configuration
1. Configure RLS policies in Supabase:
   - **Public Read:** Allow SELECT on `cars` where `durum = 'Yayında'`
   - **Authenticated Insert:** Allow INSERT for authenticated users (if needed)
   - **Admin Full Access:** Allow all operations for service role or admin users
2. Test RLS policies to ensure proper access control

### Phase 5: Testing
1. Test all CRUD operations:
   - ✅ List cars (main page)
   - ✅ View car details
   - ✅ Upload new car listing
   - ✅ Admin: View all cars
   - ✅ Admin: Edit car
   - ✅ Admin: Update status
   - ✅ Admin: Delete car
   - ✅ Filtering (search, brand, price, location, etc.)
   - ✅ Similar cars functionality
2. Test image handling:
   - ✅ Image upload and display
   - ✅ Multiple images per car
   - ✅ Image order/display
3. Performance testing:
   - ✅ Query performance
   - ✅ Pagination (if needed)
   - ✅ Index usage

### Phase 6: Deployment
1. Update production environment variables
2. Deploy updated code
3. Monitor for errors
4. Keep Airtable as backup initially (optional)

## 4. Key Considerations

### Advantages of Migration
- ✅ Better scalability (PostgreSQL)
- ✅ More flexible querying (SQL)
- ✅ Better performance (indexes, optimized queries)
- ✅ Real-time subscriptions (Supabase Realtime)
- ✅ Better security (RLS policies)
- ✅ No API rate limits (like Airtable)
- ✅ Better data relationships (foreign keys)

### Challenges to Address
- ⚠️ **Image Storage:** Currently using ImgBB. Options:
  - Keep ImgBB (simplest)
  - Migrate to Supabase Storage (better integration)
- ⚠️ **URL Changes:** Car detail URLs use Airtable record IDs. Need to:
  - Use UUID in URLs instead
  - Or create a mapping table
- ⚠️ **Favorites:** Currently stored in localStorage. May want to migrate to database.
- ⚠️ **Field Name Mapping:** Code uses both `fields.Marka` and `fields.marka`. Ensure consistent mapping.

### Migration Strategy Options

**Option 1: Big Bang Migration**
- Migrate all at once
- Switch completely to Supabase
- Risk: Downtime if issues occur

**Option 2: Gradual Migration (Recommended)**
- Run both systems in parallel
- Gradually switch features
- Keep Airtable as fallback
- Risk: More complex, dual maintenance

**Option 3: Read-Only Migration**
- Migrate data to Supabase
- Use Supabase for reads
- Keep Airtable for writes initially
- Gradually migrate writes
- Risk: Data sync issues

## 5. Code Changes Summary

### Files to Modify
1. ✅ `config.js` - Update credentials
2. ✅ `airtable.js` - Rewrite to use Supabase (rename to `cars.js`?)
3. ✅ `detail.js` - Update fetch functions
4. ✅ `upload.js` - Update insert logic
5. ✅ `admin.js` - Update all CRUD operations

### New Files to Create
1. ✅ `supabase.js` - Supabase client and helpers
2. ✅ `migrate_airtable_to_supabase.js` - Data migration script
3. ✅ `supabase_schema.sql` - Database schema (✅ DONE)

### Files to Keep
- All HTML files (no changes needed)
- CSS files (no changes needed)
- Other utilities (favorites.js, etc. - may need minor updates)

## 6. Testing Checklist

- [ ] Database schema created successfully
- [ ] Data migration script runs without errors
- [ ] All cars imported correctly
- [ ] Images imported correctly
- [ ] Main page displays cars correctly
- [ ] Car detail page displays correctly
- [ ] Upload form creates new listing
- [ ] Admin dashboard shows all cars
- [ ] Admin can edit cars
- [ ] Admin can update status
- [ ] Admin can delete cars
- [ ] Filtering works correctly
- [ ] Search works correctly
- [ ] Price filtering works correctly
- [ ] Similar cars feature works
- [ ] RLS policies enforce correct access
- [ ] Performance is acceptable
- [ ] Error handling works correctly

---

**Generated:** 2024
**Status:** Analysis Complete ✅ | SQL Schema Ready ✅ | Migration Plan Documented ✅

